<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>rent-a-car documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/Stripe.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">rent-a-car documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">







<ol class="breadcrumb">
  <li>Injectables</li>
  <li>ProcessUnavailabilityPipe</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/rental/pipes/process-unavailability.pipe.ts</code>
        </p>

            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p><strong>summary</strong>: query for any scheduled unavailability already in the database that would overlap with this request to add more unavailability to the Rental
This is to prevent the user on the front-end from accidentally overlapping &#39;blocks&#39; of scheduled unavailability. The front-end of course should also block this</p>

            </p>


            <p class="comment">
                <h3>Example</h3>
            </p>
            <div class="io-description">
            </div>

            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#addUnavailabilityId">addUnavailabilityId</a>
                            </li>
                            <li>
                                    <span class="modifier">Protected</span>
                                <a href="#createQuery">createQuery</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#transform">transform</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>


            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="transform"></a>
                    <span class="name">
                        <b>
                            <span class="modifier">Async</span>
                            transform
                        </b>
                        <a href="#transform"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>transform(value: <a href="../classes/ValidatedUnavailabilityDto.html">ValidatedUnavailabilityDto</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="121"
                            class="link-to-prism">src/rental/pipes/process-unavailability.pipe.ts:121</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p><strong>summary</strong>: process the request to update a rental&#39;s &#39;scheduled unavailability&#39;</p>
<ul>
<li>the user may schedule as far as a year ahead. To easily track the data as a single &#39;block&#39; of unavailable time for the rental, each Unavailability document related to this query is given the same &#39;uuid&#39;</li>
</ul>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                    <td>Description</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>value</td>
                                    <td>
                                                <code><a href="../classes/ValidatedUnavailabilityDto.html" target="_self" >ValidatedUnavailabilityDto</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                    <td>
                                        <p>the validated unavailability request dto</p>

                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;ProcessedUnavailabilityDto&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="addUnavailabilityId"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Protected</span>
                            addUnavailabilityId</b>
                            <a href="#addUnavailabilityId"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="57" class="link-to-prism">src/rental/pipes/process-unavailability.pipe.ts:57</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p><strong>summary</strong>: add unavailabilityId (uuid) to each UnavailabilityDto in the incoming ValidatedUnavailabilityDto</p>
<ul>
<li>this method checks if the user is schedling time only for this year or into the next year as well</li>
<li>the uuid identifies a series of unavailability, allowing the entire block of time to be identified in the database</li>
</ul>
</div>
                    </td>
                </tr>

                    <tr>
                        <td class="col-md-4">
                          <div class="io-description">
                                  <b>Parameters :</b>
                                  <table class="params">
                                      <thead>
                                          <tr>
                                                <td>Name</td>
                                                    <td>Description</td>
                                          </tr>
                                      </thead>
                                      <tbody>
                                                <tr>
                                                        <td>value</td>
                                                        <td>
                                                                <code><p>the semi processed and validate client request data</p>
</code>
                                                        </td>
                                                </tr>
                                      </tbody>
                                  </table>
                          </div>
                        </td>
                    </tr>
            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="createQuery"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Protected</span>
                            createQuery</b>
                            <a href="#createQuery"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="19" class="link-to-prism">src/rental/pipes/process-unavailability.pipe.ts:19</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p><strong>summary</strong>: create a MongoDB query object from the provided CreateQueryDto</p>
</div>
                    </td>
                </tr>

                    <tr>
                        <td class="col-md-4">
                          <div class="io-description">
                                  <b>Parameters :</b>
                                  <table class="params">
                                      <thead>
                                          <tr>
                                                <td>Name</td>
                                                    <td>Description</td>
                                          </tr>
                                      </thead>
                                      <tbody>
                                                <tr>
                                                        <td>year</td>
                                                        <td>
                                                                <code><p>data for creating a MongoDB update object</p>
</code>
                                                        </td>
                                                </tr>
                                      </tbody>
                                  </table>
                          </div>
                        </td>
                    </tr>
            </tbody>
        </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, PipeTransform, Logger } from &#x27;@nestjs/common&#x27;;
import { ValidatedUnavailabilityDto } from &#x27;../dto/unavailability/validated-unavailability.dto&#x27;;
import { ProcessedUnavailabilityDto } from &#x27;../dto/unavailability/schedule/processed-unavailability.dto&#x27;;
import { UnavailabilityQueryDto } from &#x27;../dto/unavailability/schedule/unavailability-query.dto&#x27;;
import { CreateQueryDto } from &#x27;../dto/unavailability/schedule/create-query.dto&#x27;;
import { ProcessedUnavailabilityQueryDto } from &#x27;../dto/unavailability/schedule/processed-unavailability-query.dto&#x27;;
/**
 * **summary**: query for any scheduled unavailability already in the database that would overlap with this request to add more unavailability to the Rental
 * This is to prevent the user on the front-end from accidentally overlapping &#x27;blocks&#x27; of scheduled unavailability. The front-end of course should also block this
 * @param year 
 */
@Injectable()
export class ProcessUnavailabilityPipe implements PipeTransform {

  /**
   * **summary**: create a MongoDB query object from the provided CreateQueryDto
   * @param year data for creating a MongoDB update object
   */
  protected createQuery &#x3D; async (
    year: CreateQueryDto,
  ): Promise&lt;UnavailabilityQueryDto&gt; &#x3D;&gt; {
    return {
      rentalId: year.min.rentalId,
      year: year.year,
      doy: { $lte: year.max.doy, $gte: year.min.doy },
      $or: [
        {
          // enclosed
          start: { $gte: year.start },
          end: { $lte: year.end },
        },
        {
          // offset before start
          start: { $lte: year.start },
          end: { $gte: year.start },
        },
        {
          // offset after end
          start: { $lte: year.end },
          end: { $gte: year.end },
        },
        {
          // outside
          start: { $lte: year.start },
          end: { $gte: year.end },
        },
      ],
    };
  }

  /**
   * **summary**: add unavailabilityId (uuid) to each UnavailabilityDto in the incoming ValidatedUnavailabilityDto
   * - this method checks if the user is schedling time only for this year or into the next year as well
   * - the uuid identifies a series of unavailability, allowing the entire block of time to be identified in the database
   * @param value the semi processed and validate client request data
   */
  protected addUnavailabilityId &#x3D; async (
    value: ValidatedUnavailabilityDto,
  ): Promise&lt;{
    pY1: ProcessedUnavailabilityQueryDto[];
    pY2: ProcessedUnavailabilityQueryDto[] | null;
  }&gt; &#x3D;&gt; {
    // temp arrays for transformation
    const tY1 &#x3D; [];
    const tY2 &#x3D; [];
    const uuid &#x3D; Date.now().toString();
    // process 2 years
    if (value.y2) {
      value.y1.map(x &#x3D;&gt; {
        // y1
        tY1.push({
          unavailabilityId: uuid,
          rentalId: x.rentalId,
          year: x.year,
          doy: x.doy,
          start: x.start,
          end: x.end,
          title: x.title,
        });
      });
      value.y2.map(x &#x3D;&gt; {
        // y2
        tY2.push({
          unavailabilityId: uuid,
          rentalId: x.rentalId,
          year: x.year,
          doy: x.doy,
          start: x.start,
          end: x.end,
          title: x.title,
        });
      });
      // return processedUnavailabilityDto
      const pY1: ProcessedUnavailabilityQueryDto[] &#x3D; tY1;
      const pY2: ProcessedUnavailabilityQueryDto[] &#x3D; tY2;
      return { pY1, pY2 };
    }
    // process 1 year
    const ty1 &#x3D; [];
    value.y1.map(x &#x3D;&gt; {
      // y1
      ty1.push({
        unavailabilityId: uuid,
        rentalId: x.rentalId,
        year: x.year,
        doy: x.doy,
        start: x.start,
        end: x.end,
        title: x.title,
      });
    });
    const py1: ProcessedUnavailabilityQueryDto[] &#x3D; ty1;
    return { pY1: py1, pY2: null };
  }

  /**
   * **summary**: process the request to update a rental&#x27;s &#x27;scheduled unavailability&#x27;
   * - the user may schedule as far as a year ahead. To easily track the data as a single &#x27;block&#x27; of unavailable time for the rental, each Unavailability document related to this query is given the same &#x27;uuid&#x27;
   * @param value the validated unavailability request dto
   */
  async transform(
    value: ValidatedUnavailabilityDto,
  ): Promise&lt;ProcessedUnavailabilityDto&gt; {
    // add uuid
    const {pY1, pY2} &#x3D; await this.addUnavailabilityId(value);
    const { y1, y2 } &#x3D; value;
    // create Unavailability model queries for each year
    if (y2 !&#x3D;&#x3D; null) {
      const createQuery1: CreateQueryDto &#x3D; {
        min: y1[0],
        max: y1[y1.length - 1],
        year: y1[0].year,
        start: y1[0].start,
        end: y1[0].end,
      };
      const createQuery2: CreateQueryDto &#x3D; {
        min: y2[0],
        max: y2[y2.length - 1],
        year: y2[0].year,
        start: y2[0].start,
        end: y2[0].end,
      };
      return {
        y1Query: await this.createQuery(createQuery1),
        y2Query: await this.createQuery(createQuery2),
        data: {
          y1: pY1,
          y2: pY2,
        },
      };
    }
    // create an Unavailability model query for just one year
    const createQuery &#x3D; {
      min: y1[0],
      max: y1[y1.length - 1],
      year: y1[0].year,
      start: y1[0].start,
      end: y1[0].end,
    };
    return {
      y1Query: await this.createQuery(createQuery),
      y2Query: null,
      data: {
        y1: pY1,
        y2: null,
      },
    };
  }
}
</code></pre>
    </div>

</div>







                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'ProcessUnavailabilityPipe.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
